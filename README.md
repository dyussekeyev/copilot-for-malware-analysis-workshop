# Copilot for Malware Analysis Workshop

Welcome!

This repository contains self-guided materials to help you explore the capabilities of AI for malware analysis. Although this guide uses Microsoft Copilot, the capabilities are similar across all contemporary NLP models based on the Transformer architecture.

> [!CAUTION]
> This repository contains malware that was initially created to harm computer systems. Although the samples have been deactivated using special techniques, they still contain dangerous code. Be cautious before using it and only use it for this workshop. Do not download or run it.

## Requirements

To complete the workshop tasks, you will need the following software installed:
- Microsoft Windows 10/11.
- Microsoft Edge with Copilot.

Also, you are required to have or [create](https://support.microsoft.com/en-us/account-billing/how-to-create-a-new-microsoft-account-a84675c3-3e9e-17cf-2911-3d56b15c0aaf) a Microsoft account.

To understand AI and Copilot technology, you are recommended to complete the following free Microsoft courses:
- [Fundamental AI Concepts](https://learn.microsoft.com/en-us/training/modules/get-started-ai-fundamentals/)
- [Fundamentals of Generative AI](https://learn.microsoft.com/en-us/training/modules/fundamentals-generative-ai/)

# Completing tasks

> [!TIP]
> A few tips before you get started:
> * Working with GPT models reminds imperative programming, on the one side, and communicating with a toddler, on the other side. Iterate and modify your requests basing on previous answers until you receive adequate results.
> * Since the workshop is designed to use the free version of Copilot embedded in the Edge browser, there are certain restrictions, such as content filters and rate limits. If you encounter a situation where Copilot refuses to respond, simply try to start a new topic. If the AI informs you that you have exceeded the number of requests, please try to continue the workshop the following day.
> * Keep in mind that AI can respond differently to the same prompts. There is an element of randomness involved.

## Log in into Copilot at Edge

Use your Microsoft account to log in to the Edge browser. After that, you can enter a test prompt into Copilot. Usually, Copilot uses the GPT-4 model, but if you’re lucky, it will use GPT-4 Turbo.

#### Test prompt:
```
Hi, which GPT model are you using?
```
#### Possible answer:
> Hi! I’m powered by GPT-4 Turbo, an advanced version of GPT-4. This model offers faster performance and enhanced capabilities compared to its predecessors1. How can I assist you today?

#### Demo:

![Login into Edge](https://raw.githubusercontent.com/dyussekeyev/copilot-for-malware-analysis-workshop/main/misc/screen_login.gif)

## Sample 1. PHP web shell

> [!NOTE]
> The first sample is a PHP web shell designed to execute commands encrypted with OpenSSL. According to [Mandiant](https://cloud.google.com/blog/topics/threat-intelligence/citrix-zero-day-espionage/), it was used in a state-sponsored attack and is part of the SECRETSAUCE family of web shells.

**Step 1.** Open the first [sample file](https://github.com/dyussekeyev/copilot-for-malware-analysis-workshop/blob/main/samples/script_php.txt) named `script_php.txt` in Edge, view it in raw format, and then open Copilot. Select `This page` as the source. Ensure that Copilot has access to the page with the following prompt:

```
What programming language is this code written in?
```

You should receive something like this:
> The code snippet you have is written in PHP. You can identify this by the opening <?php tag and the use of PHP-specific functions like header(), http_response_code(), and eval().

#### Demo:

![Login into Edge](https://raw.githubusercontent.com/dyussekeyev/copilot-for-malware-analysis-workshop/main/misc/screen_open_raw.gif)

**Step 2.** Start analyzing the malware using the following prompts and compare your answers with the provided results:

```
Is the code malicious or dangerous?
```
> The PHP code snippet you provided has several **security vulnerabilities** that could be exploited maliciously:
> - **Use of** `eval()`: The `eval()` function executes arbitrary PHP code, which can be dangerous if the input is not properly sanitized.
> - **Public Key Handling**: The code includes a public key and uses it to decrypt commands, which could be exploited if the key is compromised.
> - **Command Execution**: The `run()` method executes commands from user input, which can lead to remote code execution if not handled securely.
> - **Base64 Decoding**: The `decode()` method decodes base64-encoded data, which could be used to obfuscate malicious payloads.
> It’s important to review and secure this code to prevent potential exploits. Using tools like **RIPS** or **PHPStan** can help identify and fix these vulnerabilities12.

```
What does this code do? Describe it in as much detail as possible.
```

> This PHP script appears to be a **malicious backdoor**. Here’s a detailed breakdown of its functionality:
> 1. **Script Deactivation**: The script starts with `exit();` to deactivate itself, likely to avoid detection.
> 2. **HTTP Headers**: It sets HTTP headers to prevent caching and returns a 500 Internal Server Error.
> 3. **RSA Class**: The `rsa` class contains several methods:
> - **keys()**: Returns a hardcoded RSA public key.
> - **run($a)**: Executes the provided code using `eval()`.
> - **get($qs)**: Retrieves and decrypts commands from a POST request, using the RSA public key to decrypt them.
> - **decode($e)**: Decodes a base64-encoded string.
> 4. **Execution**: The script creates an instance of the `rsa` class and runs the decrypted commands.
> This script is designed to execute arbitrary code on the server, making it highly dangerous.


**Step 3.** Let’s proceed with more specific questions about the malware’s structure. You might notice that the PHP script initializes the `rsa` class. Explore its methods. What details are you interested in? Below are several possible prompts for Copilot

```
Explain what the openssl_pkey_get_public function is for.
```
```
Explain why the RSA public key is needed here.
```
```
Explain how the argument for eval() command is encoded.
```
Compare the Copilot's answers with your expectations. What satisfied you, and what did not?


**Step 4.** Finally, ask Copilot to create a detection rule based on YARA syntax.

```
Create a YARA rule that detects this file.
```
> Sure! Here’s a YARA rule to detect the PHP file you provided:
> ```
> rule Detect_RSA_PHP_Script {
>     meta:
>         description = "Detects a specific PHP script with RSA encryption"
>         author = "Copilot"
>         date = "2024-09-16"
>         hash = "0377dc9c7cfcd1e64598c619821ca114"
> 
>     strings:
>         $php_tag = "<?php"
>         $md5_comment = "Original MD5: 0377dc9c7cfcd1e64598c619821ca114"
>         $exit_function = "exit();"
>         $cache_control = "Cache-Control: no-cache, no-store, must-revalidate"
>         $pragma = "Pragma: no-cache"
>         $expires = "Expires: Wed, 11 Jan 1984 05:00:00 GMT"
>         $http_response_code = "http_response_code(500);"
>         $rsa_class = "class rsa {"
>         $public_key = "-----BEGIN PUBLIC KEY-----"
>         $eval_function = "return @eval($a);"
> 
>     condition:
>         all of ($php_tag, $md5_comment, $exit_function, $cache_control, $pragma, $expires, $http_response_code, $rsa_class, $public_key, $eval_function)
> }
> ```
> This rule looks for specific strings within the PHP file to identify it. If you need further customization or have any questions, feel free to ask!

Look at the detection rule above. How well done do you think it is?


**Step 5.** Let's polish the prompt a bit so that it uses the right strings:

```
Create a YARA rule that detects this file. Use string arguments as initial parameters. Avoid using MD5 values.
```

> Sure! Here’s a YARA rule to detect the PHP file you provided:
> ```
> rule Detect_RSA_PHP
> {
>     meta:
>         description = "Detects a specific PHP file containing RSA class and eval function"
>         author = "Your Name"
>         date = "2024-09-16"
> 
>     strings:
>         $php_tag = "<?php"
>         $rsa_class = "class rsa"
>         $public_key = "-----BEGIN PUBLIC KEY-----"
>         $eval_function = "eval("
>         $openssl = "openssl_pkey_get_public"
> 
>     condition:
>         all of them
> }
> ```
> This rule looks for specific strings that are unique to the PHP file you shared, such as the RSA class definition, the public key, and the use of the eval function. If you need further customization or have any questions, feel free to ask!


## Sample 2. Batch script with PowerShell

> [!NOTE]
> The second sample is a batch file for Windows system that loads and executes encoded PowerShell script. [Checkpoint](https://research.checkpoint.com/2023/chain-reaction-rokrats-missing-link/) identified this script as ROKRAT.

**Step 1.** Open the second [sample file](https://github.com/dyussekeyev/copilot-for-malware-analysis-workshop/blob/main/samples/script_bat.txt) named `script_bat.txt` in Edge, view it in raw format, and then open Copilot. Select `This page` as the source. Ensure that Copilot has access to the page with the following prompt:

```
What programming language is this code written in?
```

You should receive something like this:
> The code snippet on the page is written in **Batch script** and **PowerShell**.
> 
> - **Batch Script**: The initial part of the code uses batch commands like `@echo off`, `IF EXIST`, and `start /MIN`.
> - **PowerShell**: The script then sets the path to PowerShell and executes PowerShell commands using `-command`.
>
> Is there anything specific you would like to know or do with this code?


